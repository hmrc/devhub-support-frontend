@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components.{CharacterCount => CC}
@import views.html.helper.CSPNonce

@import uk.gov.hmrc.apiplatform.modules.tpd.session.domain.models.UserSession
@import uk.gov.hmrc.devhubsupportfrontend.controllers.SupportDetailsForm
@import uk.gov.hmrc.devhubsupportfrontend.controllers.SupportData
@import uk.gov.hmrc.devhubsupportfrontend.domain.models.SupportFlow
@import uk.gov.hmrc.devhubsupportfrontend.domain.models.upscan.services._
@import uk.gov.hmrc.devhubsupportfrontend.views.html.templates.Layout

@this(
        layout: Layout,
        govukButton: GovukButton,
        govukInput: GovukInput,
        govukFieldset: GovukFieldset,
        govukCharacterCount: GovukCharacterCount
)

@(loggedInSession: Option[UserSession], form: Form[SupportDetailsForm], supportFlow: SupportFlow, upscanInitiateResponse: UpscanInitiateResponse)(implicit request: play.api.mvc.RequestHeader, messages: Messages, appConfig: AppConfig)

@hiddenIfLoggedIn = {
@loggedInSession.map(_ => " hidden").getOrElse("")
}

@makingACallHeading = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us about the @{
        supportFlow.api.getOrElse("")
    } API call you need help with</h1>
    <p class="govuk-body">It helps if you can tell us the:</p>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-6">
        <li>API version</li>
        <li>environment</li>
        <li>endpoint</li>
        <li>page URL</li>
    </ul>
}

@examplesHeading = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us about the @{
        supportFlow.api.getOrElse("")
    } information you need help with</h1>
    <p class="govuk-body">It helps if you can tell us the:</p>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-6">
        <li>API version</li>
        <li>environment</li>
        <li>endpoint</li>
        <li>page URL</li>
    </ul>
}

@reportingHeading = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us what you need to report about the @{
        supportFlow.api.getOrElse("")
    } documentation</h1>
    <p class="govuk-body">It helps if you can tell us the:</p>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-6">
        <li>API version</li>
        <li>environment</li>
        <li>endpoint</li>
        <li>page URL</li>
    </ul>
}

@findHeading = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us about the software that you're building</h1>
    <p class="govuk-body"><a class="govuk-link" target="_blank" href=@{
        s"${appConfig.apiDocumentationFrontendUrl}/api-documentation/docs/api"
    }>Search our list of APIs (opens in new tab)</a> to find what's available.</p>
    <p class="govuk-body">
        If you cannot find the API you need or are not sure which version to use, complete this form.</p>
    <p class="govuk-body">Tell us about the software application or process you're working on, including the:</p>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-6">
        <li>tax or scheme it relates to</li>
        <li>declaration or return it will send</li>
        <li>type of tax number or reference it uses</li>
    </ul>
}

@completingTermsOfUseAgreement = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us about the terms of use agreement you need help with</h1>
    <p class="govuk-body">Tell us the name of the application and what you need help with.</p>
}

@generalApplicationQuery = {
    <h1 class="govuk-heading-l govuk-!-margin-bottom-6">Tell us about your query</h1>
    <p class="govuk-body">Provide as much information as you can so that we can help you as quickly as possible.</p>
}

@additionalScripts = {
  <script @CSPNonce.attr src='@routes.Assets.versioned("javascripts/upscan-upload.js")'></script>
}
    
@formFields = {
    @govukInput(
        Input(
            id = "fullName",
            name = "fullName",
            label = Label(
                isPageHeading = true,
                classes = "govuk-label--s" + hiddenIfLoggedIn,
                content = Text("Full name")
            ),
            classes = "govuk-!-width-full" + hiddenIfLoggedIn,
            value = form("fullName").value.orElse(loggedInSession.map(_.developer.displayedName)),
            errorMessage = form.error("fullName").map(e => ErrorMessage(content = Text(messages(e.message))))
        )
    )

    @govukInput(
        Input(
            id = "emailAddress",
            name = "emailAddress",
            label = Label(
                isPageHeading = true,
                classes = "govuk-label--s" + hiddenIfLoggedIn,
                content = Text("Email address")
            ),
            hint = Some(
                Hint(
                    content = Text("Weâ€™ll only use this to send you emails about your support request."),
                    classes = "govuk-hint" + hiddenIfLoggedIn
                )
            ),
            classes = "govuk-!-width-full" + hiddenIfLoggedIn,
            value = form("emailAddress").value.orElse(loggedInSession.map(_.developer.email.text)),
            errorMessage = form.error("emailAddress").map(e => ErrorMessage(content = Text(messages(e.message))))
        )
    )

    <div class="url-field-wrapper">
        <label for="website-url">Your website</label>
        <input type="text" id="website-url" name="url" tabindex="-1" autocomplete="nope" />
    </div>

    @govukInput(
        Input(
            id = "teamMemberEmailAddress",
            name = "teamMemberEmailAddress",
            value = form("teamMemberEmailAddress").value,
            label = Label(
                isPageHeading = true,
                classes = "govuk-label--s",
                content = Text("Team member's email address (optional)")
            ),
            hint = Some(
                Hint(
                    content = Text("You can add someone else to this support request. Make sure you have permission to share their email address with us.")
                )
            ),
            classes = "govuk-!-width-full",
            errorMessage = form.error("teamMemberEmailAddress").map(e => ErrorMessage(content = Text(messages(e.message))))
        )
    )

    @govukInput(
        Input(
            id = "organisation",
            name = "organisation",
            value = form("organisation").value,
            label = Label(
                isPageHeading = true,
                classes = "govuk-label--s",
                content = Text("Your business or organisation (optional)")
            ),
            classes = "govuk-!-width-full"
        )
    )

    @govukCharacterCount(CC(
        id = "details",
        name = "details",
        label = Label(
            isPageHeading = true,
            classes = "govuk-label--s",
            content = Text("Details")
        ),
        value = form("details").value,
        maxLength = Some(3000),
        hint = Some(
            Hint(
                content = Text("Do not include personal or financial information such as your National Insurance number or credit card details.")
            )
        ),
        errorMessage = form.error("details").map(e => ErrorMessage(content = Text(messages(e.message))))
    )
    )
}

@layout(
    pageTitle = "Tell us about your query",
    backLink = Some(BackLink.mimicsBrowserBackButtonViaJavaScript),
    loggedInSession = loggedInSession,
    form = Some(form)
) {
    <div id="upload-context" data-context-type="support-request"></div>
    <span class="govuk-caption-l">Support</span>

    @{
        //$COVERAGE-OFF$
    }
    @* The following section is tested in acceptance tests *@
    @{
        supportFlow.entrySelection match {
            case SupportData.UsingAnApi.id => supportFlow.subSelection match {
                case Some(SupportData.MakingAnApiCall.id) => makingACallHeading
                case Some(SupportData.GettingExamples.id) => examplesHeading
                case Some(SupportData.ReportingDocumentation.id) => reportingHeading
                case Some(SupportData.NoneOfTheAbove.id) => generalApplicationQuery
                case _ => generalApplicationQuery
            }
            case SupportData.SettingUpApplication.id => supportFlow.subSelection match {
                case Some(SupportData.CompletingTermsOfUseAgreement.id) => completingTermsOfUseAgreement
                case Some(SupportData.NoneOfTheAbove.id) => generalApplicationQuery
                case _ => generalApplicationQuery
            }
            case SupportData.FindingAnApi.id => findHeading
            // TODO - needs design input
            case SupportData.SigningIn.id => generalApplicationQuery
            case SupportData.NoneOfTheAbove.id => generalApplicationQuery
            case _ => generalApplicationQuery
        }
    }

    @{
        //$COVERAGE-ON$
    }

    @helper.form(action = uk.gov.hmrc.devhubsupportfrontend.controllers.routes.SupportDetailsController.submitSupportDetailsWithAttachments(), 'id -> "details-form") {
        @helper.CSRF.formField
        
        @for(index <- form("fileAttachments").indexes) {
          <input type="hidden" name="fileAttachments[@index].fileReference" value="@{form(s"fileAttachments[$index].fileReference").value.getOrElse("")}">
          <input type="hidden" name="fileAttachments[@index].fileName" value="@{form(s"fileAttachments[$index].fileName").value.getOrElse("")}">
        }
        
        @govukFieldset(Fieldset(
            legend = None,
            html = formFields
        ))

        @* Display-only file upload section, so that it appears above main form submit buttons.
        The upscan form cannot be inside the main form (nested forms are not allowed)
        The real upscan form is below the main form, and the selected file to upload is copied over by javascript *@
        <div class="upload-section">
            <div class="govuk-form-group">
                <label class="govuk-label govuk-!-font-weight-bold" for="file-upload-1">
                    Add files to your support request
                </label>
                <div id="file-upload-1-hint" class="govuk-hint">
                    Accepted file types are:
                    <ul>
                        <li>image (jpeg, jpg, png)</li>
                        <li>pdf</li>
                        <li>text files (doc, docx, txt, csv)</li>
                        <li>Spreadsheets (xls, xlsx)</li>
                    </ul>
                </div>
                
                <p class="govuk-body" aria-live="polite"><span id="files-uploaded">0</span> of a maximum of 5 files uploaded</p>
                <input class="govuk-file-upload" id="file-upload-1" type="file"  accept=".xls,.xlsx, .jpg, .jpeg,.png, .doc, .docx, .txt, .csv, .pdf">
                <dl class="govuk-summary-list govuk-summary-list--long-key govuk-!-margin-top-4" id="upload-summary"></dl>
            </div>
        </div>

        @govukButton(
            Button(
                id = Some("send"),
                content = Text("Send"),
                preventDoubleClick = Some(true)
            )
        )
    }

    @* Real upscan form (hidden) The selected file to upload is copied over by javascript from the file upload section above *@
    <form action="@upscanInitiateResponse.postTarget" method="post" enctype="multipart/form-data" id="upscan-form" style="display: none;">
        @for(field <- upscanInitiateResponse.formFields) {
            <input type="hidden" name="@field._1" value="@field._2"/>
        }
        <input type="file" name="file" id="upscan-file-input">
    </form>

    @additionalScripts
}
